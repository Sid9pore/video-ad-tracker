package rabbitmq

import (
	"encoding/json"
	"log"

	"github.com/Sid9pore/video-ad-tracker/ads"
	"github.com/streadway/amqp"
)

func startConsumer(mq *amqp.Channel, repo Repository) {
	msgs, err := mq.Consume("clicks_queue", "", true, false, false, false, nil)
	if err != nil {
		log.Fatalf("consume error: %v", err)
	}
	for msg := range msgs {
		var click ads.ClickData
		if err := json.Unmarshal(msg.Body, &click); err != nil {
			log.Printf("unmarshal error: %v", err)
			continue
		}
		// Persist via repo
		if err := repo.LogClick(click); err != nil {
			log.Printf("db insert error: %v", err)
			// Optionally: requeue or dead-letter
		}
	}
}
